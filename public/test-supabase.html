<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Supabase - Sistema Neuropsicologia</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .error { background: #ffeaea; border-left: 4px solid #f44336; }
        .warning { background: #fff3cd; border-left: 4px solid #ff9800; }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 300px;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1976d2; }
        .disabled { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste de Integra√ß√£o Supabase</h1>
        <p>Esta p√°gina verifica se o Supabase est√° configurado corretamente no sistema.</p>
        
        <div id="config-status">
            <h3>üìä Status da Configura√ß√£o</h3>
            <div id="config-results">Carregando...</div>
        </div>
        
        <div id="connection-test">
            <h3>üåê Teste de Conex√£o</h3>
            <button onclick="testConnection()">Testar Conex√£o</button>
            <div id="connection-results"></div>
        </div>
        
        <div id="database-test">
            <h3>üóÑÔ∏è Teste de Banco de Dados</h3>
            <button onclick="testDatabase()">Testar Tabelas</button>
            <div id="database-results"></div>
        </div>
        
        <div id="auth-test">
            <h3>üîê Teste de Autentica√ß√£o</h3>
            <button onclick="testAuth()">Testar Auth</button>
            <div id="auth-results"></div>
        </div>
        
        <div id="logs">
            <h3>üìã Logs do Console</h3>
            <pre id="console-logs"></pre>
        </div>
    </div>

    <!-- Configura√ß√£o autom√°tica via build -->
    <script>
        window.ENV = {
            SUPABASE_URL: 'https://wltzckgdtvlhdmhyozsb.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsdHpja2dkdHZsaGRtaHlvenNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MTUzNjEsImV4cCI6MjA1MTM5MTM2MX0.Ojs7E9Yc4J2qxkTTGKUEdjFhS0JfXHZBK-yWAhwlDXY',
            BUILD_TIME: '2025-07-02T20:03:00.275Z',
            ENVIRONMENT: 'test',
            IS_VERCEL: true
        };
    </script>

    <script type="module">
        let logs = [];
        
        // Capturar logs do console
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = (...args) => {
            logs.push(`[LOG] ${args.join(' ')}`);
            updateLogs();
            originalLog.apply(console, args);
        };
        
        console.warn = (...args) => {
            logs.push(`[WARN] ${args.join(' ')}`);
            updateLogs();
            originalWarn.apply(console, args);
        };
        
        console.error = (...args) => {
            logs.push(`[ERROR] ${args.join(' ')}`);
            updateLogs();
            originalError.apply(console, args);
        };
        
        function updateLogs() {
            document.getElementById('console-logs').textContent = logs.slice(-20).join('\n');
        }
        
        function showResult(elementId, status, message, details = null) {
            const element = document.getElementById(elementId);
            const className = status === 'success' ? 'success' : 
                            status === 'error' ? 'error' : 
                            status === 'warning' ? 'warning' : 'info';
            
            let html = `<div class="status ${className}">
                <strong>${message}</strong>
                ${details ? `<pre>${JSON.stringify(details, null, 2)}</pre>` : ''}
            </div>`;
            
            element.innerHTML = html;
        }
        
        // Verificar configura√ß√£o inicial
        function checkConfig() {
            const config = {
                supabaseUrl: window.ENV?.SUPABASE_URL || 'n√£o configurado',
                supabaseKey: window.ENV?.SUPABASE_ANON_KEY ? window.ENV.SUPABASE_ANON_KEY.substring(0, 20) + '...' : 'n√£o configurado',
                environment: window.ENV?.ENVIRONMENT || 'desconhecido',
                buildTime: window.ENV?.BUILD_TIME || 'n√£o dispon√≠vel'
            };
            
            const hasValidConfig = window.ENV?.SUPABASE_URL && 
                                 window.ENV.SUPABASE_URL.includes('supabase.co') && 
                                 !window.ENV.SUPABASE_URL.includes('your-project') &&
                                 window.ENV?.SUPABASE_ANON_KEY && 
                                 window.ENV.SUPABASE_ANON_KEY !== 'your-anon-key';
            
            showResult('config-results', 
                hasValidConfig ? 'success' : 'error',
                hasValidConfig ? '‚úÖ Configura√ß√£o v√°lida encontrada' : '‚ùå Configura√ß√£o inv√°lida ou ausente',
                config
            );
            
            return hasValidConfig;
        }
        
        // Testar conex√£o com Supabase
        window.testConnection = async function() {
            showResult('connection-results', 'info', 'üîÑ Testando conex√£o...');
            
            try {
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                
                const supabase = createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);
                window.testSupabase = supabase;
                
                const { data, error } = await supabase.auth.getSession();
                
                if (error && error.message !== 'No active session') {
                    throw error;
                }
                
                showResult('connection-results', 'success', '‚úÖ Conex√£o com Supabase estabelecida', {
                    url: window.ENV.SUPABASE_URL,
                    session: data ? 'Ativa' : 'N√£o autenticado (normal)'
                });
                
            } catch (error) {
                showResult('connection-results', 'error', '‚ùå Erro na conex√£o', {
                    erro: error.message,
                    stack: error.stack
                });
            }
        };
        
        // Testar acesso ao banco de dados
        window.testDatabase = async function() {
            if (!window.testSupabase) {
                showResult('database-results', 'warning', '‚ö†Ô∏è Execute o teste de conex√£o primeiro');
                return;
            }
            
            showResult('database-results', 'info', 'üîÑ Testando acesso ao banco...');
            
            try {
                const tables = ['clients', 'schedules', 'users', 'stock_items'];
                const results = {};
                
                for (const table of tables) {
                    try {
                        const { data, error, count } = await window.testSupabase
                            .from(table)
                            .select('*', { count: 'exact', head: true });
                        
                        if (error) {
                            results[table] = `‚ùå Erro: ${error.message}`;
                        } else {
                            results[table] = `‚úÖ OK (${count || 0} registros)`;
                        }
                    } catch (err) {
                        results[table] = `‚ùå Erro: ${err.message}`;
                    }
                }
                
                const hasErrors = Object.values(results).some(r => r.includes('‚ùå'));
                
                showResult('database-results', 
                    hasErrors ? 'warning' : 'success',
                    hasErrors ? '‚ö†Ô∏è Algumas tabelas com problemas' : '‚úÖ Todas as tabelas acess√≠veis',
                    results
                );
                
            } catch (error) {
                showResult('database-results', 'error', '‚ùå Erro no teste de banco', {
                    erro: error.message
                });
            }
        };
        
        // Testar autentica√ß√£o
        window.testAuth = async function() {
            if (!window.testSupabase) {
                showResult('auth-results', 'warning', '‚ö†Ô∏è Execute o teste de conex√£o primeiro');
                return;
            }
            
            showResult('auth-results', 'info', 'üîÑ Testando autentica√ß√£o...');
            
            try {
                // Testar login com credenciais de teste
                const { data, error } = await window.testSupabase.auth.signInWithPassword({
                    email: 'coord@clinica.com',
                    password: 'coord123'
                });
                
                if (error) {
                    showResult('auth-results', 'warning', '‚ö†Ô∏è Teste de login falhou (esperado)', {
                        erro: error.message,
                        info: 'Isto √© normal se n√£o houver usu√°rios criados no Supabase Auth'
                    });
                } else {
                    showResult('auth-results', 'success', '‚úÖ Autentica√ß√£o funcionando', {
                        usuario: data.user?.email,
                        id: data.user?.id
                    });
                    
                    // Fazer logout
                    await window.testSupabase.auth.signOut();
                }
                
            } catch (error) {
                showResult('auth-results', 'error', '‚ùå Erro no teste de auth', {
                    erro: error.message
                });
            }
        };
        
        // Executar verifica√ß√£o inicial
        document.addEventListener('DOMContentLoaded', () => {
            checkConfig();
        });
        
        console.log('üß™ P√°gina de teste Supabase carregada');
        console.log('üîß Configura√ß√£o:', window.ENV);
    </script>
</body>
</html> 